<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Validaci贸n EMO</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; }
.container { max-width:420px; margin:40px auto; background:#fff; padding:25px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,.1); }
h2 { text-align:center; margin-bottom:20px; }
form { display:flex; flex-direction:column; gap:12px; }
input, button { padding:10px 12px; font-size:16px; border-radius:6px; border:1px solid #ccc; width:100%; box-sizing:border-box; }
input { height:46px; background:#fff; }
button { background:#3498db; color:#fff; border:none; cursor:pointer; }
button:disabled { opacity:.6; }
#spinner { display:none; text-align:center; margin:20px; }
.loader { border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:auto; }
@keyframes spin { to { transform:rotate(360deg); } }
#resultado { margin-top:20px; font-size:15px; }
.item { margin-bottom:8px; }
</style>
</head>

<body>

<div class="container">
<h2>VALIDA TU EMO AQUv3.4</h2>

<form id="formBusqueda">
<label style="font-size:13px;color:#666;">Ingrese NRO de DNI</label>
<input type="text" id="dni" placeholder="12345678" inputmode="numeric" required autofocus>

<label style="font-size:13px;color:#666;">Seleccione la fecha del EMO</label>
<input type="date" id="fecha" required>
<button type="submit" id="btnBuscar">Buscar</button>
</form>

<div id="spinner"><div class="loader"></div></div>
<div id="resultado"></div>

<div style="text-align:right;font-size:12px;color:#777;margin-top:14px;font-style:italic;">
sistema creado por Santiago Pazos
</div>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbx1ddte-FxaG2I4pkNQts17ELvVaWUYb3ta9hczxaqe7Rb2n6SxyeozkN4YRZzTTO2eHQ/exec";
const LOGO_URL = "./logo.png";
const LOGO_WATERMARK = "./logo_claro.png";

const form = document.getElementById("formBusqueda");
const btnBuscar = document.getElementById("btnBuscar");
const spinner = document.getElementById("spinner");
const resultado = document.getElementById("resultado");

form.addEventListener("submit", e => {
  e.preventDefault();
  buscar();
});

function buscar() {
  const dni = document.getElementById("dni").value.trim();
  const fecha = document.getElementById("fecha").value;
  if (!dni || !fecha) return alert("Ingrese DNI y fecha");

  btnBuscar.disabled = true;
  spinner.style.display = "block";
  resultado.innerHTML = "";

  fetch(URL + "?dni=" + encodeURIComponent(dni) + "&fecha=" + encodeURIComponent(fecha))
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        resultado.innerHTML = "<b style='color:red'>" + data.error + "</b>";
        return;
      }

      const ahora = new Date().toLocaleString("es-PE");

      resultado.innerHTML = `
        <div class="item"><b>Apellidos y nombres:</b> ${data.nombres}</div>
        <div class="item"><b>DNI:</b> ${data.dni}</div>
        <div class="item"><b>Fecha:</b> ${data.fecha}</div>
        <div class="item"><b>Empresa:</b> ${data.empresa}</div>
        <div class="item"><b>Tipo de EMO:</b> ${data.tipoEMO}</div>
        <div class="item"><b>Criterio de aptitud:</b> ${data.criterioAptitud}</div>
        <hr>
        <div style="font-size:13px;color:#555">
          <b>Consulta realizada:</b> ${ahora}<br>
          Validado en prevemedicaperu.com/validar
        </div><br>
        <button id="btnPDF" style="width:100%;background:#2ecc71">Descargar esta validaci贸n aqu铆</button>
      `;

      setTimeout(()=>{
        document.getElementById("btnPDF").addEventListener("click",()=>generarPDF(data));
      },0);
    })
    .finally(() => {
      spinner.style.display = "none";
      btnBuscar.disabled = false;
    });
}
</script>

<script>
window.generarPDF = async function(datos){

  //  VENTANA ABIERTA POR EL CLICK (MVIL OK)
  const pdfWindow = window.open("", "_blank");
  if (!pdfWindow) { alert("Habilite ventanas emergentes"); return; }
  pdfWindow.document.write("Generando PDF...");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // MARCOS
  doc.setDrawColor(180,180,180); doc.setLineWidth(1.5); doc.rect(8,8,194,281);
  doc.setDrawColor(210,210,210); doc.setLineWidth(0.5); doc.rect(12,12,186,273);

  const ahora = new Date().toLocaleString("es-PE");
  const codigo = generarCodigoUnico(datos);
  await registrarDescarga(datos, codigo);

  const logoWatermark = await cargarImagen(LOGO_WATERMARK);
  const baseURL = window.location.origin + window.location.pathname;
  const qr = await generarQR(`${baseURL}?dni=${datos.dni}&fecha=${datos.fecha}`);

  if (LOGO_URL) doc.addImage(LOGO_URL,"PNG",13,15,45,16);
  if (logoWatermark) doc.addImage(logoWatermark,"PNG",25,90,160,50);

  doc.setFont("Helvetica","bold"); doc.setFontSize(15);
  doc.text("CONSTANCIA DE VALIDACIN EMO",105,35,{align:"center"});

  let y=50; doc.setFontSize(11); doc.setFont("Helvetica","normal");
  doc.text("Apellidos y nombres: "+datos.nombres,20,y); y+=8;
  doc.text("DNI: "+datos.dni,20,y); y+=8;
  doc.text("Fecha EMO: "+datos.fecha,20,y); y+=8;
  doc.text("Empresa: "+datos.empresa,20,y); y+=8;
  doc.text("Tipo EMO: "+datos.tipoEMO,20,y); y+=8;
  doc.text("Criterio de aptitud: "+datos.criterioAptitud,20,y); y+=12;

  doc.setFont("Helvetica","bold");
  doc.text("C贸digo 煤nico de validaci贸n:",20,y); y+=7;
  doc.setFontSize(10);
  doc.text(codigo,20,y); y+=12;

  doc.setFont("Helvetica","italic");
  doc.text("Consulta realizada: "+ahora,20,y); y+=7;
  doc.text("Validado en prevemedicaperu.com/validar",20,y);

  if (qr) doc.addImage(qr,"PNG",150,55,40,40);

  const blob = doc.output("bloburl");
  pdfWindow.location.href = blob;
}

// =========================
function generarCodigoUnico(datos){
  return btoa(datos.dni+"|"+datos.fecha+"|"+Date.now()).replace(/=/g,"").substring(0,14).toUpperCase();
}

async function registrarDescarga(datos,codigo){
  const form=new FormData();
  form.append("accion","registro_pdf");
  form.append("dni",datos.dni);
  form.append("fecha",datos.fecha);
  form.append("codigo",codigo);
  try{ await fetch(URL,{method:"POST",body:form}); }catch{}
}

function cargarImagen(url){
  return new Promise(resolve=>{
    const img=new Image();
    img.crossOrigin="anonymous";
    img.onload=()=>{const c=document.createElement("canvas");c.width=img.width;c.height=img.height;c.getContext("2d").drawImage(img,0,0);resolve(c.toDataURL("image/png"));};
    img.onerror=()=>resolve(null);
    img.src=url;
  });
}

function generarQR(texto){
  return new Promise(resolve=>{
    try{
      const d=document.createElement("div");
      new QRCode(d,{text:texto,width:200,height:200});
      setTimeout(()=>{const img=d.querySelector("img"); resolve(img?img.src:null);},300);
    }catch{ resolve(null); }
  });
}
</script>

</body>
</html>

